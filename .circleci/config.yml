# This file is generated by script/generate_circleci.clj. Please do not edit here.
version: 2.1
jobs:
  linux-hsqldb:
    resource_class: large
    docker:
    - {image: 'circleci/clojure:lein-2.8.1'}
    steps:
    - checkout
    - run:
        name: Pull Submodules
        command: |
          git submodule init
          git submodule update
    - restore_cache:
        keys: ['linux-{{ checksum "project.clj" }}-{{ checksum ".circleci/config.yml" }}']
    - run:
        name: Install Clojure
        command: |2-

          wget https://download.clojure.org/install/linux-install-1.10.1.447.sh
          chmod +x linux-install-1.10.1.447.sh
          sudo ./linux-install-1.10.1.447.sh
    - run:
        name: Install lsof
        command: |
          sudo apt-get install lsof
    - run:
        name: Install native dev tools
        command: |
          sudo apt-get update
          sudo apt-get -y install gcc g++ zlib1g-dev
    - run:
        name: Download GraalVM
        command: |2-

          cd ~
          if ! [ -d graalvm-ce-java8-19.3.1 ]; then
            curl -O -sL https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-19.3.1/graalvm-ce-java8-linux-amd64-19.3.1.tar.gz
            tar xzf graalvm-ce-java8-linux-amd64-19.3.1.tar.gz
          fi
    - run:
        name: Build binary
        command: |
          # script/uberjar
          script/compile
        no_output_timeout: 30m
    - run:
        name: Run tests
        command: |
          script/test
    - run:
        name: Release
        command: |
          .circleci/script/release
    - save_cache:
        key: linux-{{ checksum "project.clj" }}-{{ checksum ".circleci/config.yml" }}
        paths: [~/.m2, ~/graalvm-ce-java8-19.3.1]
    - store_artifacts: {path: /tmp/release, destination: release}
    working_directory: ~/repo
    environment: {GRAALVM_HOME: /home/circleci/graalvm-ce-java8-19.3.1, POD_TEST_ENV: native, BABASHKA_PLATFORM: linux, BABASHKA_XMX: -J-Xmx7g, LEIN_ROOT: 'true', POD_FEATURE_HSQLDB: 'true', BABASHKA_TEST_ENV: native}
  mac-hsqldb:
    macos: {xcode: '9.0'}
    resource_class: large
    steps:
    - checkout
    - run:
        name: Pull Submodules
        command: |
          git submodule init
          git submodule update
    - restore_cache:
        keys: ['mac-{{ checksum "project.clj" }}-{{ checksum ".circleci/config.yml" }}']
    - run:
        name: Install Clojure
        command: |
          script/install-clojure /usr/local
    - run:
        name: Install Leiningen
        command: |
          script/install-leiningen
    - run:
        name: Download GraalVM
        command: |2-

          cd ~
          ls -la
          if ! [ -d graalvm-ce-java8-19.3.1 ]; then
            curl -O -sL https://github.com/graalvm/graalvm-ce-builds/releases/download/vm-19.3.1/graalvm-ce-java8-darwin-amd64-19.3.1.tar.gz
            tar xzf graalvm-ce-java8-darwin-amd64-19.3.1.tar.gz
          fi
    - run:
        name: Build binary
        command: |
          # script/uberjar
          script/compile
        no_output_timeout: 30m
    - run:
        name: Run tests
        command: |
          script/test
    - run:
        name: Release
        command: |
          .circleci/script/release
    - save_cache:
        key: mac-{{ checksum "project.clj" }}-{{ checksum ".circleci/config.yml" }}
        paths: [~/.m2, ~/graalvm-ce-java8-19.3.1]
    - store_artifacts: {path: /tmp/release, destination: release}
    environment: {GRAALVM_HOME: /Users/distiller/graalvm-ce-java8-19.3.1/Contents/Home, POD_TEST_ENV: native, BABASHKA_PLATFORM: macos, BABASHKA_XMX: -J-Xmx7g, POD_FEATURE_HSQLDB: 'true', BABASHKA_TEST_ENV: native}
workflows:
  version: 2
  ci:
    jobs: [linux-hsqldb, mac-hsqldb]
